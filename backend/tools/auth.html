<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Auth (simple)</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            padding: 20px;
        }

        label {
            display: block;
            margin: 8px 0;
        }

        input {
            padding: 6px 8px;
            width: 100%;
            max-width: 420px;
        }

        button {
            margin-top: 8px;
            padding: 8px 12px;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 6px;
            max-width: 720px;
            overflow: auto;
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }
    </style>
</head>

<body>
    <h1>Clerk Auth â€” Simple</h1>

    <label>
        Publishable key
        <input id="publishable-key" placeholder="pk_test_..." autocomplete="off" />
    </label>

    <div class="row">
        <button id="init-clerk">Load Clerk</button>
        <button id="fetch-token" disabled>Fetch token</button>
        <button id="sign-out" disabled>Sign out</button>
        <button id="clear-output">Clear</button>
    </div>

    <p id="status">Provide a publishable key and load Clerk.</p>

    <h2>Session</h2>
    <pre id="session-output">null</pre>

    <h2>Token</h2>
    <pre id="token-output">// no token</pre>

    <script type="module">
        const keyInput = document.getElementById("publishable-key");
        const initButton = document.getElementById("init-clerk");
        const fetchButton = document.getElementById("fetch-token");
        const signOutButton = document.getElementById("sign-out");
        const clearButton = document.getElementById("clear-output");
        const statusEl = document.getElementById("status");
        const sessionOutput = document.getElementById("session-output");
        const tokenOutput = document.getElementById("token-output");

        let isClerkReady = false;

        function setStatus(msg) {
            statusEl.textContent = msg;
        }

        initButton.addEventListener("click", () => {
            const key = keyInput.value.trim();
            if (!key) {
                setStatus("Enter publishable key.");
                return;
            }
            loadClerk(key);
        });

        fetchButton.addEventListener("click", async () => {
            if (!isClerkReady || !window.Clerk || !window.Clerk.session) {
                setStatus("No active session.");
                return;
            }
            try {
                setStatus("Fetching token...");
                const token = await window.Clerk.session.getToken();
                tokenOutput.textContent = token || "// empty token";
                setStatus("Token fetched.");
            } catch (e) {
                console.error(e);
                setStatus(`Token error: ${e?.message}`);
            }
        });

        signOutButton.addEventListener("click", async () => {
            if (!isClerkReady || !window.Clerk) return;
            try {
                await window.Clerk.signOut();
                setStatus("Signed out.");
                updateSession(null);
            } catch (e) {
                console.error(e);
                setStatus("Sign out failed");
            }
        });

        clearButton.addEventListener("click", () => {
            sessionOutput.textContent = "null";
            tokenOutput.textContent = "// no token";
            setStatus("Cleared.");
        });

        function loadClerk(key) {
            if (isClerkReady) {
                setStatus("Clerk already loaded");
                return;
            }
            setStatus("Loading Clerk...");
            const s = document.createElement("script");
            s.src =
                "https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js";
            s.async = true;
            s.setAttribute("data-clerk-publishable-key", key);
            s.onload = async () => {
                try {
                    await window.Clerk.load();
                    isClerkReady = true;
                    setStatus("Clerk ready.");
                    fetchButton.disabled = false;
                    signOutButton.disabled = false;
                    updateSession(window.Clerk.session);
                    if (window.Clerk.addListener) {
                        window.Clerk.addListener(({ session }) => updateSession(session));
                    }
                } catch (e) {
                    console.error(e);
                    setStatus("Clerk init error");
                }
            };
            s.onerror = () => setStatus("Failed to load Clerk bundle");
            document.head.appendChild(s);
        }

        function updateSession(session) {
            if (!session) {
                sessionOutput.textContent = "null";
                return;
            }
            try {
                sessionOutput.textContent = JSON.stringify(
                    typeof session.toJSON === "function" ? session.toJSON() : session,
                    null,
                    2
                );
            } catch (e) {
                console.error(e);
                sessionOutput.textContent = String(session);
            }
        }
    </script>
</body>

</html>